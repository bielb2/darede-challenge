# "org" ensures this Service is used with the correct Serverless Framework Access Key.
org: daredechallenge
# "app" enables Serverless Framework Dashboard features and sharing them with other Services.
app: daredechallenge
service: serverless-order-processor

provider:
  name: aws
  runtime: nodejs18.x
  stage: ${opt:stage, 'dev'}
  region: us-east-1
  environment:
    ORDERS_TABLE: ${self:service}-orders-${self:provider.stage}
    ORDERS_QUEUE_URL:
      Ref: OrdersQueue
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:UpdateItem
          Resource:
            Fn::GetAtt:
              - OrdersTable
              - Arn
        - Effect: Allow
          Action:
            - sqs:SendMessage
          Resource:
            Fn::GetAtt:
              - OrdersQueue
              - Arn
  tracing:
    lambda: true
    apiGateway: true

functions:
  createOrder:
    handler: src/handlers/createOrder.handler
    events:
      - http:
          path: /orders
          method: post
          cors: true

  getOrder:
    handler: src/handlers/getOrder.handler
    events:
      - http:
          path: /orders/{orderId}
          method: get
          cors: true

  processPayment:
    handler: src/handlers/processPayment.handler
    timeout: 15
    events:
      - sqs:
          arn:
            Fn::GetAtt:
              - OrdersQueue
              - Arn
          batchSize: 1

resources:
  Resources:
    OrdersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.ORDERS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: orderId
            AttributeType: S
        KeySchema:
          - AttributeName: orderId
            KeyType: HASH

    OrdersQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-orders-queue-${self:provider.stage}
        VisibilityTimeout: 30
        MessageRetentionPeriod: 86400
        RedrivePolicy:
          deadLetterTargetArn:
            Fn::GetAtt:
              - OrdersDLQ
              - Arn
          maxReceiveCount: 3

    OrdersDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-orders-dlq-${self:provider.stage}
        MessageRetentionPeriod: 1209600

plugins:
  - serverless-offline

custom:
  serverless-offline:
    httpPort: 3000
